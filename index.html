<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویزیت پزشکان آزمایشگاه فروردین</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- کتابخانه Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- کتابخانه‌های نقشه Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f0f4f8; }
        .loader { border-top-color: #60a5fa; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        #map { height: 400px; border-radius: 0.5rem; background-color: #e9e9e9; }
        .day-button { padding: 0.5rem 0.75rem; font-size: 0.875rem; font-weight: 500; color: #374151; background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 9999px; transition: all 0.2s; cursor: pointer; }
        .day-button.active { background-color: #14b8a6; color: white; border-color: #0f766e; }
        summary::marker { content: ' ▼'; font-size: 0.8em; }
        details[open] summary::marker { content: ' ▲'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .recording-indicator { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-6">
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">سامانه مدیریت ویزیت پزشکان</h1>
        </header>

        <!-- بخش جستجو -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4">جستجوی آنی</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="prNameSearch" placeholder="نام پرسنل..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="text" id="doctorNameSearch" placeholder="نام پزشک..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="tel" inputmode="numeric" id="medicalIdSearch" placeholder="شماره نظام پزشکی..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <div class="md:col-span-3 relative">
                    <input type="text" id="specialtySearch" placeholder="جستجوی تخصص..." class="p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <div id="specialtyResults" class="absolute z-10 w-full bg-white border border-gray-200 rounded-b-lg mt-1 max-h-48 overflow-y-auto shadow-lg"></div>
                    <div id="selectedSpecialtiesContainer" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div id="results" class="mt-6">
                <div id="loader" class="hidden justify-center items-center py-10"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div></div>
                <p id="noResults" class="text-center text-gray-500 py-10">برای مشاهده نتایج، جستجو کنید.</p>
                <div id="resultsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- بخش ورود دستی اطلاعات -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-teal-700 border-b border-teal-200 pb-3 mb-4">ثبت دستی ویزیت جدید</h2>
            <form id="manualEntryForm">
                <input type="hidden" id="recordedAudioUrl">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">
                    <div class="col-span-1 md:col-span-2 lg:col-span-3">
                        <label for="repNameSelect" class="block text-sm font-medium text-gray-700 mb-1">نماینده علمی</label>
                        <select id="repNameSelect" required class="w-full p-3 bg-teal-50 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-400"></select>
                    </div>
                    <input type="text" id="doctorName" placeholder="نام پزشک" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="medicalId" placeholder="شماره نظام پزشکی" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <input type="tel" inputmode="numeric" pattern="09[0-9]{9}" maxlength="11" id="doctorPhone" placeholder="شماره پزشک (اختیاری)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <input type="text" id="specialty" placeholder="تخصص" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <input type="text" id="secretaryName" placeholder="نام منشی (اختیاری)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <input type="tel" inputmode="numeric" pattern="09[0-9]{9}" maxlength="11" id="secretaryPhone" placeholder="شماره منشی (اختیاری)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">روز کاری</label>
                        <div id="workDaysContainer" class="flex flex-wrap gap-2">
                            <button type="button" data-day="شنبه" class="day-button">شنبه</button>
                            <button type="button" data-day="یکشنبه" class="day-button">یکشنبه</button>
                            <button type="button" data-day="دوشنبه" class="day-button">دوشنبه</button>
                            <button type="button" data-day="سه‌شنبه" class="day-button">سه‌شنبه</button>
                            <button type="button" data-day="چهارشنبه" class="day-button">چهارشنبه</button>
                            <button type="button" data-day="پنجشنبه" class="day-button">پنجشنبه</button>
                        </div>
                    </div>
                    <input type="text" id="workHours" placeholder="ساعت کاری" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400 self-end">
                    <div class="col-span-1 md:col-span-2 lg:col-span-3">
                         <label for="address" class="block text-sm font-medium text-gray-700 mb-1">آدرس</label>
                         <div class="flex items-center gap-2">
                            <input type="text" id="address" placeholder="آدرس متنی" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400">
                            <button type="button" id="openMapBtn" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition whitespace-nowrap">نقشه</button>
                         </div>
                         <input type="hidden" id="latitude"> <input type="hidden" id="longitude">
                    </div>
                     <div>
                        <label for="visitDate" class="block text-sm font-medium text-gray-700 mb-1">تاریخ ویزیت</label>
                        <input type="date" id="visitDate" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400 w-full">
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 pt-4 border-t">
                        <label for="visitNotes" class="block text-sm font-medium text-gray-700 mb-2">توضیحات ویزیت</label>
                        <textarea id="visitNotes" rows="3" placeholder="توضیحات متنی..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-400"></textarea>
                    </div>
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">عکس‌ها و صدای مطب</label>
                        <div class="flex items-center gap-2">
                            <input type="file" id="clinicImages" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button type="button" id="openVoiceRecorderBtn" class="bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition whitespace-nowrap flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                                <span id="voiceBtnText">ضبط صدا</span>
                            </button>
                        </div>
                        <div id="imagePreviewContainer" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-teal-600 transition">ثبت اطلاعات</button>
                </div>
            </form>
            <div id="manualEntryStatus" class="mt-4 text-center"></div>
        </div>

        <!-- بخش مدیریت پرسنل و آپلود -->
        <details class="bg-white shadow-md rounded-lg p-6 mb-6">
            <summary class="text-xl font-semibold text-blue-700 cursor-pointer">مدیریت پرسنل و بارگذاری گروهی</summary>
            <div class="mt-4 pt-4 border-t">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">افزودن نماینده جدید</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="newRepName" placeholder="نام و نام خانوادگی نماینده" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400">
                    <button id="addRepButton" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition">افزودن</button>
                </div>
                <div id="addRepStatus" class="mt-2 text-center"></div>
            </div>
            <div class="mt-4 pt-4 border-t">
                 <h3 class="text-lg font-semibold text-gray-700 mb-2">بارگذاری گروهی از فایل اکسل</h3>
                <div class="flex flex-col items-center p-4 border-2 border-dashed border-gray-200 rounded-lg">
                    <input type="file" id="excelFile" accept=".csv, .xls, .xlsx" class="block w-full max-w-xs text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <button id="uploadButton" class="mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">بارگذاری</button>
                    <div id="uploadStatus" class="mt-4 text-center"></div>
                </div>
            </div>
        </details>
    </div>

    <!-- Modals -->
    <div id="mapModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50"><div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"><h3 class="text-lg font-medium text-gray-900 mb-4">موقعیت را روی نقشه انتخاب کنید</h3><div id="map"></div><div class="flex justify-end items-center gap-4 mt-4"><button id="confirmLocationBtn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition">تایید</button><button id="closeMapBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">بستن</button></div></div></div>
    <div id="errorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900">خطا</h3><div class="mt-2 px-7 py-3"><div id="errorMessage" class="text-sm text-gray-500 whitespace-pre-line text-right"></div></div><div class="items-center px-4 py-3"><button id="closeModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600">متوجه شدم</button></div></div></div></div>
    <div id="detailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50"><div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white"><div id="detailsModalContent"></div><div id="detailsModalActions" class="mt-4 text-left space-x-2 space-x-reverse"></div></div></div>

    <div id="voiceRecorderModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="w-full bg-white rounded-2xl p-8 space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800">ضبط کننده صدا</h1>
                    <p class="text-gray-500 mt-2">صدا را ضبط و برای این ویزیت ذخیره کنید</p>
                </div>
                <div id="voiceStatus" class="text-center text-lg font-semibold text-gray-600 h-auto flex items-center justify-center">آماده برای ضبط</div>
                <div class="flex justify-center items-center space-x-4 space-x-reverse">
                    <button id="startRecordingBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-green-400 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2 space-x-reverse">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        <span>شروع ضبط</span>
                    </button>
                    <button id="stopRecordingBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-red-400 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2 space-x-reverse" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6" /></svg>
                        <span>پایان ضبط</span>
                    </button>
                </div>
                <div id="audioPlayerContainer" class="hidden pt-4">
                     <audio id="audioPlayer" controls class="w-full"></audio>
                </div>
                <div class="mt-4 text-center">
                    <button id="closeVoiceRecorderBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://ntqjobefllhnrtafvpdq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50cWpvYmVmbGxobnJ0YWZ2cGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNDM5MjksImV4cCI6MjA3MDkxOTkyOX0.rg3wTml0PQcoceiAR3qSXIF1JBddtZcvXYiGBOA0x1M';
        const AUDIO_BUCKET_NAME = 'clinic_audio';
        const IMAGE_BUCKET_NAME = 'clinic_images';
        
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Element Caching ---
        const excelFileInput = document.getElementById('excelFile'), uploadButton = document.getElementById('uploadButton'), uploadStatus = document.getElementById('uploadStatus');
        const prNameSearch = document.getElementById('prNameSearch'), doctorNameSearch = document.getElementById('doctorNameSearch'), medicalIdSearch = document.getElementById('medicalIdSearch');
        const specialtySearchInput = document.getElementById('specialtySearch'), specialtyResultsContainer = document.getElementById('specialtyResults'), selectedSpecialtiesContainer = document.getElementById('selectedSpecialtiesContainer');
        const resultsContainer = document.getElementById('resultsContainer'), loader = document.getElementById('loader'), noResults = document.getElementById('noResults');
        const errorModal = document.getElementById('errorModal'), errorMessage = document.getElementById('errorMessage'), closeModal = document.getElementById('closeModal');
        const manualEntryForm = document.getElementById('manualEntryForm'), repNameSelect = document.getElementById('repNameSelect'), manualEntryStatus = document.getElementById('manualEntryStatus');
        const openMapBtn = document.getElementById('openMapBtn'), closeMapBtn = document.getElementById('closeMapBtn'), confirmLocationBtn = document.getElementById('confirmLocationBtn'), mapModal = document.getElementById('mapModal');
        const workDaysContainer = document.getElementById('workDaysContainer');
        const newRepNameInput = document.getElementById('newRepName'), addRepButton = document.getElementById('addRepButton'), addRepStatus = document.getElementById('addRepStatus');
        const clinicImagesInput = document.getElementById('clinicImages'), imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const detailsModal = document.getElementById('detailsModal'), detailsModalContent = document.getElementById('detailsModalContent'), detailsModalActions = document.getElementById('detailsModalActions');
        const addressInput = document.getElementById('address');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const recordedAudioUrlInput = document.getElementById('recordedAudioUrl');

        const voiceRecorderModal = document.getElementById('voiceRecorderModal');
        const openVoiceRecorderBtn = document.getElementById('openVoiceRecorderBtn');
        const closeVoiceRecorderBtn = document.getElementById('closeVoiceRecorderBtn');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const voiceStatusDiv = document.getElementById('voiceStatus');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const voiceBtnText = document.getElementById('voiceBtnText');
        
        // --- Global State ---
        let map, marker, currentResults = [], selectedSpecialties = [];
        let mediaRecorder, audioChunks = [], isRecording = false;
        let isEditModeVoice = false; // Flag to check if recorder is opened from edit modal
        let currentEditingDoctorId = null; // To store doctor ID during edit voice recording

        // --- Utility Functions ---
        function debounce(func, delay) { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => func.apply(this, a), delay); }; }
        function showErrorModal(msg, isHtml = false) { if (isHtml) errorMessage.innerHTML = msg; else errorMessage.textContent = msg; errorModal.classList.remove('hidden'); }

        // --- Core Application Logic ---

        async function fetchRepresentatives() {
            const { data, error } = await sb.from('pr_personnel').select('name');
            if (error) return showErrorModal("خطا در بارگذاری لیست نمایندگان.");
            repNameSelect.innerHTML = '<option value="">لطفا یک نماینده را انتخاب کنید...</option>';
            data.sort((a, b) => a.name.localeCompare(b.name, 'fa')).forEach(rep => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = rep.name;
                repNameSelect.appendChild(opt);
            });
        }
        
        async function handleAddRepresentative() {
            const repName = newRepNameInput.value.trim();
            if (!repName) return showErrorModal("لطفاً نام نماینده را وارد کنید.");
            addRepStatus.innerHTML = `<div class="flex items-center justify-center text-green-600"><div class="loader h-5 w-5 mr-2"></div></div>`;
            const { error } = await sb.from('pr_personnel').insert({ name: repName });
            if (error) {
                showErrorModal(`خطا: ${error.message}`);
                addRepStatus.innerHTML = `<p class="text-red-600">عملیات ناموفق بود.</p>`;
            } else {
                addRepStatus.innerHTML = `<p class="text-green-600">نماینده '${repName}' اضافه شد.</p>`;
                newRepNameInput.value = '';
                await fetchRepresentatives();
            }
        }

        const performSearch = debounce(async () => {
            const prName = prNameSearch.value.trim(), doctorName = doctorNameSearch.value.trim(), medicalId = medicalIdSearch.value.trim();
            if (!prName && !doctorName && !medicalId && selectedSpecialties.length === 0) {
                resultsContainer.innerHTML = '';
                noResults.textContent = "برای مشاهده نتایج، جستجو کنید.";
                noResults.classList.remove('hidden');
                return;
            }
            resultsContainer.innerHTML = ''; noResults.classList.add('hidden'); loader.classList.remove('hidden');
            
            let query = sb.from('doctors').select('*');
            if (prName) query = query.ilike('rep_name', `%${prName}%`);
            if (doctorName) query = query.ilike('name', `%${doctorName}%`);
            if (medicalId) query = query.ilike('medical_id', `%${medicalId}%`);
            if (selectedSpecialties.length > 0) query = query.in('specialty', selectedSpecialties);

            const { data, error } = await query;
            loader.classList.add('hidden');
            if (error) showErrorModal(`خطا در جستجو: ${error.message}`);
            else {
                currentResults = data;
                displayResults(data);
            }
        }, 500);

        const searchSpecialties = debounce(async () => {
            const queryText = specialtySearchInput.value.trim();
            if (queryText.length < 2) { specialtyResultsContainer.innerHTML = ''; return; }

            const { data, error } = await sb.from('doctors').select('specialty').ilike('specialty', `%${queryText}%`).not('specialty', 'is', null).limit(20);
            if (error || !data) { specialtyResultsContainer.innerHTML = ''; return; }
            
            const uniqueSpecialties = [...new Set(data.map(item => item.specialty.trim()))].filter(s => !selectedSpecialties.includes(s));
            specialtyResultsContainer.innerHTML = uniqueSpecialties.map(spec => 
                `<div class="p-2 hover:bg-gray-100 cursor-pointer specialty-result-item" data-spec="${spec}">${spec}</div>`
            ).join('');
        }, 300);
        
        function renderSelectedSpecialties() {
            selectedSpecialtiesContainer.innerHTML = selectedSpecialties.map(spec => `
                <span class="bg-blue-500 text-white text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2">
                    ${spec}
                    <button data-spec-remove="${spec}" class="text-blue-200 hover:text-white font-bold text-lg leading-none">&times;</button>
                </span>`
            ).join('');
            performSearch();
        }
        
        async function handleManualEntry(e) {
            e.preventDefault();
            const rep = repNameSelect.value, name = document.getElementById('doctorName').value.trim(), medId = document.getElementById('medicalId').value.trim();
            if (!rep || !name || !medId) return showErrorModal("لطفاً فیلدهای نام نماینده، نام پزشک و نظام پزشکی را پر کنید.");
            
            const { data: existingDoctor, error: checkError } = await sb.from('doctors').select('id').or(`name.eq.${name},medical_id.eq.${medId}`);
            if (checkError) { showErrorModal(`خطا در بررسی اطلاعات: ${checkError.message}`); return; }
            if (existingDoctor.length > 0) { showErrorModal("پزشکی با این نام یا شماره نظام پزشکی از قبل ثبت شده است."); return; }

            manualEntryStatus.innerHTML = `<div class="flex items-center justify-center text-teal-600"><div class="loader h-6 w-6 mr-2"></div><p>درحال ثبت...</p></div>`;
            
            const image_urls = [];
            if (clinicImagesInput.files.length > 0) {
                for (const file of clinicImagesInput.files) {
                    try {
                        const { publicUrl, error } = await uploadFile(file, IMAGE_BUCKET_NAME);
                        if (error) throw error;
                        image_urls.push(publicUrl);
                    } catch (error) {
                        showErrorModal(`خطا در آپلود عکس: ${error.message}`);
                        manualEntryStatus.innerHTML = '';
                        return;
                    }
                }
            }

            const selectedDays = Array.from(workDaysContainer.querySelectorAll('.day-button.active')).map(btn => btn.dataset.day);
            const visitDateValue = document.getElementById('visitDate').value;

            const doctorData = {
                rep_name: rep, name, medical_id: medId,
                doctor_phone: document.getElementById('doctorPhone').value.trim() || null,
                specialty: document.getElementById('specialty').value.trim() || null,
                secretary_name: document.getElementById('secretaryName').value.trim() || null,
                secretary_phone: document.getElementById('secretaryPhone').value.trim() || null,
                work_days: selectedDays.join(', ') || null,
                work_hours: document.getElementById('workHours').value.trim() || null,
                address: addressInput.value.trim() || null,
                latitude: latitudeInput.value || null,
                longitude: longitudeInput.value || null,
                visit_dates: visitDateValue ? [visitDateValue] : [], // Save as array
                visit_notes: document.getElementById('visitNotes').value.trim() || null,
                image_urls: image_urls.length > 0 ? image_urls : null,
                audio_url: recordedAudioUrlInput.value.trim() || null
            };
            
            const { error } = await sb.from('doctors').insert(doctorData);
            if (error) {
                showErrorModal(`خطا در ثبت اطلاعات: ${error.message}`);
                manualEntryStatus.innerHTML = `<p class="text-red-600">عملیات ناموفق بود.</p>`;
            } else {
                manualEntryStatus.innerHTML = `<p class="text-green-600">اطلاعات با موفقیت ثبت شد.</p>`;
                manualEntryForm.reset();
                workDaysContainer.querySelectorAll('.day-button.active').forEach(btn => btn.classList.remove('active'));
                imagePreviewContainer.innerHTML = '';
                recordedAudioUrlInput.value = '';
                openVoiceRecorderBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                openVoiceRecorderBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                voiceBtnText.textContent = 'ضبط صدا';
                document.getElementById('visitDate').valueAsDate = new Date();
                setTimeout(() => manualEntryStatus.innerHTML = '', 3000);
            }
        }

        async function handleFileUpload() {
            const file = excelFileInput.files[0];
            if (!file) return showErrorModal("لطفاً فایلی را انتخاب کنید.");
            const prName = file.name.split('.').slice(0, -1).join('.');
            if (!prName) return showErrorModal("نام فایل معتبر نیست.");

            uploadStatus.innerHTML = `<div class="flex items-center justify-center text-blue-600"><div class="loader h-6 w-6 mr-2"></div></div>`;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    const doctors = processJsonData(jsonData, prName);
                    if (doctors.length === 0) return showErrorModal("داده معتبری در فایل یافت نشد.");
                    
                    const { error } = await sb.from('doctors').insert(doctors);
                    if (error) throw error;

                    uploadStatus.innerHTML = `<p class="text-green-600">${doctors.length} رکورد برای '${prName}' ذخیره شد.</p>`;
                    excelFileInput.value = '';
                    await fetchRepresentatives();
                } catch (error) { showErrorModal(`خطا در پردازش فایل: ${error.message}`); uploadStatus.innerHTML = `<p class="text-red-600">عملیات ناموفق بود.</p>`; }
            };
            reader.readAsArrayBuffer(file);
        }

        function processJsonData(jsonData, repName) {
            return jsonData.filter(row => row['نام پزشک'] && row['شماره نظام']).map(row => ({
                rep_name: repName,
                name: String(row['نام پزشک'] || '').trim(),
                medical_id: String(row['شماره نظام'] || '').trim(),
                specialty: String(row['تخصص'] || '').trim(),
                secretary_name: String(row['نام منشی'] || '').trim(),
                secretary_phone: String(row['شماره منشی'] || '').trim(),
                doctor_phone: String(row['شماره پزشک'] || '').trim(),
                work_days: String(row['روز کاری'] || '').trim(),
                work_hours: String(row['ساعت کاری'] || '').trim(),
                address: String(row['آدرس'] || '').trim(),
                visit_notes: String(row['توضیحات'] || '').trim()
            }));
        }

        function displayResults(data) {
            resultsContainer.innerHTML = '';
            if (!data || data.length === 0) { noResults.textContent = "هیچ نتیجه‌ای یافت نشد."; noResults.classList.remove('hidden'); return; }
            noResults.classList.add('hidden');
            data.forEach(doctor => {
                const card = document.createElement('div');
                card.className = "bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-lg transition-shadow cursor-pointer";
                card.dataset.id = doctor.id;
                card.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">${doctor.name}</h3>
                    <p class="text-sm text-blue-600 font-semibold mb-2">${doctor.specialty || 'نامشخص'}</p>
                    <p class="text-gray-600 text-sm mb-1"><strong>نظام پزشکی:</strong> ${doctor.medical_id}</p>
                    <div class="mt-3 pt-3 border-t"> <p class="text-xs text-gray-500"><strong>ثبت توسط:</strong> ${doctor.rep_name}</p> </div>
                `;
                resultsContainer.appendChild(card);
            });
        }
        
        function openDetailsModal(doctorId) {
            renderDetailsView(doctorId);
            detailsModal.classList.remove('hidden');
        }

        function renderDetailsView(doctorId) {
            const doctor = currentResults.find(d => d.id == doctorId);
            if (!doctor) return;

            const locationLink = doctor.latitude && doctor.longitude ? `<a href="https://www.google.com/maps?q=${doctor.latitude},${doctor.longitude}" target="_blank" class="text-purple-600 hover:underline text-sm ml-2">(مشاهده روی نقشه)</a>` : '';
            const notes = doctor.visit_notes ? `<div class="mt-2 p-2 bg-gray-50 rounded-md"><p class="text-gray-700"><strong class="block mb-1">توضیحات:</strong> ${doctor.visit_notes}</p></div>` : '';
            const imagesHTML = Array.isArray(doctor.image_urls) && doctor.image_urls.length > 0 ? `<div class="mt-4 pt-2 border-t"><h4 class="font-semibold mb-2">عکس‌ها:</h4><div class="flex gap-2 overflow-x-auto pb-2">${doctor.image_urls.map(url => `<a href="${url}" target="_blank"><img src="${url}" class="h-24 w-24 object-cover rounded-md hover:opacity-80 transition"></a>`).join('')}</div></div>` : '';
            const audioHTML = doctor.audio_url ? `<div class="mt-4 pt-2 border-t"><h4 class="font-semibold mb-2">فایل صوتی:</h4><audio controls class="w-full"><source src="${doctor.audio_url}" type="audio/wav"></audio></div>` : '';
            
            const visitDatesHTML = Array.isArray(doctor.visit_dates) && doctor.visit_dates.length > 0 
                ? `<ul class="list-disc list-inside">${doctor.visit_dates.map(date => `<li>${new Date(date).toLocaleDateString('fa-IR')}</li>`).join('')}</ul>`
                : 'ثبت نشده';

            detailsModalContent.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-2">${doctor.name}</h2>
                <p class="text-md text-blue-600 font-semibold mb-4">${doctor.specialty || 'نامشخص'}</p>
                <div class="space-y-3 text-sm text-gray-600">
                    <div><strong>تاریخ‌های ویزیت:</strong> ${visitDatesHTML}</div>
                    <p><strong>نظام پزشکی:</strong> ${doctor.medical_id}</p>
                    <p><strong>شماره پزشک:</strong> ${doctor.doctor_phone || 'ثبت نشده'}</p>
                    <p><strong>نام منشی:</strong> ${doctor.secretary_name || 'ثبت نشده'}</p>
                    <p><strong>شماره منشی:</strong> ${doctor.secretary_phone || 'ثبت نشده'}</p>
                    <p><strong>آدرس:</strong> ${doctor.address || 'ثبت نشده'} ${locationLink}</p>
                    <p><strong>روز کاری:</strong> ${doctor.work_days || 'ثبت نشده'}</p>
                    <p><strong>ساعت کاری:</strong> ${doctor.work_hours || 'ثبت نشده'}</p>
                    ${notes}
                    ${imagesHTML}
                    ${audioHTML}
                </div>
            `;
            detailsModalActions.innerHTML = `
                <button id="editDoctorBtn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition">ویرایش</button>
                <button id="closeDetailsBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">بستن</button>
            `;
            document.getElementById('editDoctorBtn').onclick = () => renderEditView(doctorId);
            document.getElementById('closeDetailsBtn').onclick = () => detailsModal.classList.add('hidden');
        }

        function renderEditView(doctorId) {
            const doctor = currentResults.find(d => d.id == doctorId);
            if (!doctor) return;
            
            currentEditingDoctorId = doctorId; // Set current doctor for voice recording
            
            const workDays = ["شنبه", "یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنجشنبه"];
            const activeDays = doctor.work_days ? doctor.work_days.split(', ') : [];
            const daysHtml = workDays.map(day => 
                `<button type="button" data-day="${day}" class="day-button ${activeDays.includes(day) ? 'active' : ''}">${day}</button>`
            ).join('');
            
            const existingImagesHTML = Array.isArray(doctor.image_urls) && doctor.image_urls.length > 0 
                ? `<div class="flex gap-2 overflow-x-auto pb-2">${doctor.image_urls.map(url => `<img src="${url}" class="h-16 w-16 object-cover rounded-md">`).join('')}</div>` 
                : '<p class="text-xs text-gray-500">عکسی وجود ندارد.</p>';

            detailsModalContent.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ویرایش اطلاعات ${doctor.name}</h2>
                <form id="editForm" class="space-y-4">
                    <input type="hidden" id="editRecordedAudioUrl" value="${doctor.audio_url || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">نام پزشک</label><input type="text" name="name" value="${doctor.name || ''}" required class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">نظام پزشکی</label><input type="text" name="medical_id" value="${doctor.medical_id || ''}" required class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">تخصص</label><input type="text" name="specialty" value="${doctor.specialty || ''}" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">شماره پزشک</label><input type="tel" name="doctor_phone" value="${doctor.doctor_phone || ''}" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">نام منشی</label><input type="text" name="secretary_name" value="${doctor.secretary_name || ''}" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">شماره منشی</label><input type="tel" name="secretary_phone" value="${doctor.secretary_phone || ''}" class="w-full p-2 border rounded-md"></div>
                    </div>
                    <div><label class="block text-sm font-medium">آدرس</label><input type="text" name="address" value="${doctor.address || ''}" class="w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">ساعت کاری</label><input type="text" name="work_hours" value="${doctor.work_hours || ''}" class="w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium mb-2">روزهای کاری</label><div class="flex flex-wrap gap-2" id="editWorkDays">${daysHtml}</div></div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">تاریخ‌های ویزیت</label>
                        <div id="editVisitDatesContainer" class="space-y-2 mb-2"></div>
                        <div class="flex items-center gap-2">
                            <input type="date" id="newVisitDateInput" class="p-2 border rounded-md w-full">
                            <button type="button" id="addVisitDateBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">افزودن</button>
                        </div>
                    </div>

                    <div><label class="block text-sm font-medium">توضیحات</label><textarea name="visit_notes" rows="3" class="w-full p-2 border rounded-md">${doctor.visit_notes || ''}</textarea></div>
                    
                    <div class="pt-4 border-t">
                        <label class="block text-sm font-medium mb-2">عکس‌های فعلی</label>
                        ${existingImagesHTML}
                        <label class="block text-sm font-medium mt-4 mb-2">افزودن عکس جدید / ضبط صدا</label>
                        <div class="flex items-center gap-2">
                            <input type="file" id="editClinicImages" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button type="button" id="editOpenVoiceRecorderBtn" class="bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition whitespace-nowrap flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                <span>ضبط صدا</span>
                            </button>
                        </div>
                    </div>
                </form>
            `;
            detailsModalActions.innerHTML = `
                <div id="updateStatus" class="inline-block ml-4"></div>
                <button type="submit" form="editForm" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">ذخیره تغییرات</button>
                <button id="cancelEditBtn" type="button" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">انصراف</button>
            `;
            
            // Populate visit dates
            const visitDatesContainer = document.getElementById('editVisitDatesContainer');
            (doctor.visit_dates || []).forEach(date => addDateToEditUI(date, visitDatesContainer));

            document.getElementById('addVisitDateBtn').onclick = () => {
                const dateInput = document.getElementById('newVisitDateInput');
                if (dateInput.value) {
                    addDateToEditUI(dateInput.value, visitDatesContainer);
                    dateInput.value = '';
                }
            };

            document.getElementById('editForm').onsubmit = (e) => handleUpdateDoctor(e, doctorId);
            document.getElementById('cancelEditBtn').onclick = () => renderDetailsView(doctorId);
            document.getElementById('editWorkDays').onclick = (e) => {
                if (e.target.classList.contains('day-button')) e.target.classList.toggle('active');
            };
            document.getElementById('editOpenVoiceRecorderBtn').onclick = () => {
                isEditModeVoice = true;
                voiceRecorderModal.classList.remove('hidden');
            };
        }
        
        function addDateToEditUI(date, container) {
            const dateDiv = document.createElement('div');
            dateDiv.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-md';
            dateDiv.innerHTML = `
                <span class="text-sm">${new Date(date).toLocaleDateString('fa-IR')}</span>
                <input type="hidden" class="visit-date-value" value="${date}">
                <button type="button" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
            `;
            dateDiv.querySelector('button').onclick = () => dateDiv.remove();
            container.appendChild(dateDiv);
        }

        async function handleUpdateDoctor(e, doctorId) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const updateStatusDiv = document.getElementById('updateStatus');
            updateStatusDiv.innerHTML = `<div class="loader h-5 w-5 inline-block"></div>`;

            // Handle new image uploads
            const newImageFiles = document.getElementById('editClinicImages').files;
            let newImageUrls = [];
            if (newImageFiles.length > 0) {
                for (const file of newImageFiles) {
                    try {
                        const { publicUrl, error } = await uploadFile(file, IMAGE_BUCKET_NAME);
                        if (error) throw error;
                        newImageUrls.push(publicUrl);
                    } catch (error) {
                         showErrorModal(`خطا در آپلود عکس جدید: ${error.message}`);
                         updateStatusDiv.innerHTML = '';
                         return;
                    }
                }
            }
            
            const doctor = currentResults.find(d => d.id == doctorId);
            const existingImageUrls = doctor.image_urls || [];
            const finalImageUrls = [...existingImageUrls, ...newImageUrls];

            const selectedDays = Array.from(form.querySelector('#editWorkDays').querySelectorAll('.day-button.active')).map(btn => btn.dataset.day);
            const visitDates = Array.from(document.querySelectorAll('#editVisitDatesContainer .visit-date-value')).map(input => input.value);

            const updatedData = {
                name: formData.get('name').trim(),
                medical_id: formData.get('medical_id').trim(),
                specialty: formData.get('specialty').trim() || null,
                doctor_phone: formData.get('doctor_phone').trim() || null,
                secretary_name: formData.get('secretary_name').trim() || null,
                secretary_phone: formData.get('secretary_phone').trim() || null,
                address: formData.get('address').trim() || null,
                work_hours: formData.get('work_hours').trim() || null,
                visit_dates: visitDates,
                work_days: selectedDays.join(', ') || null,
                visit_notes: formData.get('visit_notes').trim() || null,
                image_urls: finalImageUrls.length > 0 ? finalImageUrls : null,
                audio_url: document.getElementById('editRecordedAudioUrl').value.trim() || null
            };

            const { error } = await sb.from('doctors').update(updatedData).eq('id', doctorId);

            if (error) {
                showErrorModal(`خطا در به‌روزرسانی: ${error.message}`);
                updateStatusDiv.innerHTML = `<p class="text-red-500 text-sm">خطا!</p>`;
            } else {
                updateStatusDiv.innerHTML = `<p class="text-green-500 text-sm">ذخیره شد!</p>`;
                setTimeout(() => {
                    detailsModal.classList.add('hidden');
                    performSearch();
                }, 1000);
            }
        }
        
        // --- Map Logic ---
        function initMap() {
            mapModal.classList.remove('hidden');
            const mapContainer = document.getElementById('map');
            mapContainer.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader h-12 w-12"></div><p class="mr-4">در حال دریافت موقعیت مکانی شما...</p></div>`;

            const setupMap = (lat, lon) => {
                mapContainer.innerHTML = ''; 
                if (!map) {
                    map = L.map('map').setView([lat, lon], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    map.on('click', (e) => {
                        if (marker) marker.setLatLng(e.latlng);
                        else marker = L.marker(e.latlng).addTo(map);
                    });
                } else {
                    map.setView([lat, lon], 16);
                }
                if (marker) marker.setLatLng([lat, lon]);
                else marker = L.marker([lat, lon]).addTo(map);
                setTimeout(() => map.invalidateSize(), 100);
            };

            const handleGeoError = (error) => {
                let message = "امکان دسترسی به موقعیت شما وجود ندارد. موقعیت پیش‌فرض (تهران) نمایش داده می‌شود.";
                if (error) {
                    switch(error.code) {
                        case error.PERMISSION_DENIED: message = "شما اجازه دسترسی به موقعیت مکانی را نداده‌اید."; break;
                        case error.POSITION_UNAVAILABLE: message = "اطلاعات موقعیت مکانی در دسترس نیست."; break;
                        case error.TIMEOUT: message = "درخواست برای دریافت موقعیت مکانی بیش از حد طول کشید."; break;
                    }
                }
                showErrorModal(message);
                setupMap(35.6892, 51.3890);
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => setupMap(position.coords.latitude, position.coords.longitude),
                    handleGeoError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showErrorModal("مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند.");
                setupMap(35.6892, 51.3890);
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=fa`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network response was not ok, status: ${response.status}`);
                }
                const data = await response.json();
                return data?.display_name || "آدرس یافت نشد";
            } catch (error) { 
                console.error("Reverse geocoding failed:", error);
                return "خطا در دریافت آدرس از سرویس نقشه."; 
            }
        }

        // --- File & Voice Recorder Logic ---
        async function uploadFile(file, bucketName) {
            const fileExtension = file.name ? file.name.split('.').pop() : 'wav';
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 11)}.${fileExtension}`;
            const filePath = `public/${fileName}`;
            
            const { error: uploadError } = await sb.storage.from(bucketName).upload(filePath, file);
            if (uploadError) throw uploadError;

            const { data } = sb.storage.from(bucketName).getPublicUrl(filePath);
            if (!data || !data.publicUrl) throw new Error("دریافت لینک عمومی فایل با مشکل مواجه شد.");
            
            return { publicUrl: data.publicUrl, error: null };
        }

        function updateVoiceUI(recordingStatus) {
            isRecording = recordingStatus;
            if (isRecording) {
                startRecordingBtn.disabled = true;
                stopRecordingBtn.disabled = false;
                voiceStatusDiv.innerHTML = `<div class="flex items-center justify-center space-x-2 space-x-reverse"><span class="w-3 h-3 bg-red-500 rounded-full recording-indicator"></span><span>در حال ضبط...</span></div>`;
                audioPlayerContainer.classList.add('hidden');
            } else {
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
                voiceStatusDiv.textContent = 'ضبط متوقف شد. در حال پردازش...';
            }
        }

        async function uploadAudioToSupabase(audioBlob) {
            try {
                voiceStatusDiv.innerHTML = `<span class="text-blue-500">در حال آپلود فایل...</span>`;
                const { publicUrl, error } = await uploadFile(audioBlob, AUDIO_BUCKET_NAME);
                if (error) throw error;
                
                if (isEditModeVoice) {
                    document.getElementById('editRecordedAudioUrl').value = publicUrl;
                } else {
                    recordedAudioUrlInput.value = publicUrl;
                    openVoiceRecorderBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    openVoiceRecorderBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    voiceBtnText.textContent = 'صدا ضبط شد';
                }

                voiceStatusDiv.innerHTML = `<span class="text-green-500">فایل صوتی با موفقیت ذخیره شد!</span>`;
                setTimeout(() => voiceRecorderModal.classList.add('hidden'), 1500);

            } catch (error) {
                console.error('خطا در آپلود صدا:', error);
                voiceStatusDiv.innerHTML = `<span class="text-red-500">خطا: ${error.message}</span>`;
            }
        }

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchRepresentatives();
            document.getElementById('visitDate').valueAsDate = new Date();
        });
        uploadButton.addEventListener('click', handleFileUpload);
        manualEntryForm.addEventListener('submit', handleManualEntry);
        addRepButton.addEventListener('click', handleAddRepresentative);
        prNameSearch.addEventListener('keyup', performSearch);
        doctorNameSearch.addEventListener('keyup', performSearch);
        medicalIdSearch.addEventListener('keyup', performSearch);
        specialtySearchInput.addEventListener('keyup', searchSpecialties);
        
        specialtyResultsContainer.addEventListener('click', e => {
             const item = e.target.closest('.specialty-result-item');
            if (item) {
                const spec = item.dataset.spec;
                if (!selectedSpecialties.includes(spec)) {
                    selectedSpecialties.push(spec);
                    specialtySearchInput.value = '';
                    specialtyResultsContainer.innerHTML = '';
                    renderSelectedSpecialties();
                }
            }
        });
        selectedSpecialtiesContainer.addEventListener('click', e => {
            const removeBtn = e.target.closest('[data-spec-remove]');
            if (removeBtn) {
                const specToRemove = removeBtn.dataset.specRemove;
                selectedSpecialties = selectedSpecialties.filter(s => s !== specToRemove);
                renderSelectedSpecialties();
            }
        });

        closeModal.addEventListener('click', () => errorModal.classList.add('hidden'));
        openMapBtn.addEventListener('click', initMap);
        closeMapBtn.addEventListener('click', () => mapModal.classList.add('hidden'));
        confirmLocationBtn.addEventListener('click', async () => {
             if (marker) {
                const { lat, lng } = marker.getLatLng();
                latitudeInput.value = lat.toFixed(7); 
                longitudeInput.value = lng.toFixed(7);
                addressInput.value = "در حال دریافت آدرس...";
                addressInput.value = await reverseGeocode(lat, lng);
            }
            mapModal.classList.add('hidden');
        });
        workDaysContainer.addEventListener('click', (e) => { if (e.target.classList.contains('day-button')) e.target.classList.toggle('active'); });
        clinicImagesInput.addEventListener('change', (event) => {
            imagePreviewContainer.innerHTML = '';
            for (const file of event.target.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'h-20 w-20 object-cover rounded-md';
                    imagePreviewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
        resultsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card) openDetailsModal(card.dataset.id);
        });

        openVoiceRecorderBtn.addEventListener('click', () => {
            isEditModeVoice = false;
            voiceRecorderModal.classList.remove('hidden');
        });
        closeVoiceRecorderBtn.addEventListener('click', () => voiceRecorderModal.classList.add('hidden'));

        startRecordingBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayerContainer.classList.remove('hidden');
                    await uploadAudioToSupabase(audioBlob);
                    audioChunks = [];
                };
                mediaRecorder.start();
                updateVoiceUI(true);
            } catch (error) {
                console.error('خطا در دسترسی به میکروفون:', error);
                voiceStatusDiv.innerHTML = `<span class="text-red-500">خطا: دسترسی به میکروفون ممکن نیست.</span>`;
            }
        });

        stopRecordingBtn.addEventListener('click', () => {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                updateVoiceUI(false);
            }
        });
    </script>
</body>
</html>
